# 视图

## 什么是视图

- 原表的一个局部
- 视图是一种 虚拟表 ，本身是不具有数据 的，占用很少的内存空间，视图建立在已有表的基础上, 视图赖以建立的这些表称为基表。
- 视图一方面可以帮我们使用表的一部分而不是所有的表，另一方面也可以针对不同的用户制定不同的查 询视图。
- 视图的创建和删除只影响视图本身，不影响对应的基表。但是当对视图中的数据进行增加、删除和 修改操作时，数据表中的数据会相应地发生变化，反之亦然。
- 向视图提供数据内容的语句为 SELECT 语句, 可以将视图理解为存储起来的 SELECT 语句

## 创建视图

```sql
CREATE VIEW 视图名称
AS 查询语句
```

- AS 后面就是正常的 select 语句，和前面一样的
- 实际上就是我们在 SQL 查询语句的基础上封装了视图 VIEW，这样就会基于 SQL 语句的结果集形 成一张虚拟表。
- 在创建视图时，没有在视图名后面指定字段列表，则视图中字段列表默认和 SELECT 语句中的字 段列表一致。如果 SELECT 语句中给字段取了别名，那么视图中的字段名和别名相同。
- 利用视图对数据进行格式化：
  - 我们经常需要输出某个格式的内容，比如我们想输出员工姓名和对应的部门名，对应格式为 emp_name(department_name)，就可以使用视图来完成数据格式化的操作：
- 当我们创建好一张视图之后，还可以在它的基础上继续创建视图

## 查看视图

### **语法 1：查看数据库中所有的表和视图对象**

```sql
SHOW TABLES;
```

这个语句会列出当前数据库中的所有 **表对象**，包括：

- 普通表（BASE TABLE）
- 视图（VIEW）

但是这个语法不会区分它们是表还是视图。要看类型，可以配合 `information_schema` 或用 `SHOW FULL TABLES`。

更详细一点（带类型）：

```sql
SHOW FULL TABLES FROM your_database_name;
```

输出结果中会有一列叫 `Table_type`，值为：

- `BASE TABLE` 表示普通表
- `VIEW` 表示视图

### **语法 2：查看视图的结构（字段定义）**

```sql
DESC 视图名;
-- 或
DESCRIBE 视图名;
```

这个语句可以查看视图的“列定义”，例如字段名、数据类型、是否允许为 NULL 等。

注意：视图的字段是来自它所引用的表，所以结构是“继承”而来的。

### **语法 3：查看视图的属性信息**

使用 `information_schema` 数据字典可以查：

```sql
SELECT * 
FROM information_schema.tables 
WHERE table_name = '视图名';
```

输出中你会看到一列 `TABLE_TYPE` 是 `VIEW`，说明这个是一个视图。

### **语法 4：查看视图的定义（完整 SQL）**

```sql
SHOW CREATE VIEW 视图名;
```

展示创建这个视图时用的完整 `CREATE VIEW` 语句，包含所有 `SELECT` 的逻辑。

## 更新视图的数据

MySQL 支持使用 INSERT、UPDATE 和 DELETE 语句对视图中的数据进行插入、更新和删除操作。当视图中的 数据发生变化时，数据表中的数据也会发生变化，反之亦然。

## 不可更新的视图

要使视图可更新，视图中的行和底层基本表中的行之间必须存在 一对一 的关系。

另外当视图定义出现如 下情况时，视图不支持更新操作：

- 在定义视图的时候指定了“ALGORITHM = TEMPTABLE”，视图将不支持 INSERT 和 DELETE 操作；
- 视图中不包含基表中所有被定义为非空又未指定默认值的列，视图将不支持 INSERT 操作；
- 在定义视图的 SELECT 语句中使用了 JOIN 联合查询 ，视图将不支持 INSERT 和 DELETE 操作；
- 在定义视图的 SELECT 语句后的字段列表中使用了 数学表达式 或 子查询 ，视图将不支持 INSERT，也 不支持 UPDATE 使用了数学表达式、子查询的字段值；
- 在定义视图的 SELECT 语句后的字段列表中使用 DISTINCT 、 聚合函数 、 GROUP BY 、 HAVING 、 UNION 等，视图将不支持 INSERT、UPDATE、DELETE；
- 在定义视图的 SELECT 语句中包含了子查询，而子查询中引用了 FROM 后面的表，视图将不支持 INSERT、UPDATE、DELETE；
- 视图定义基于一个 不可更新视图 ；
- 常量视图。

虽然可以更新视图数据，但总的来说，视图作为 虚拟表 ，主要用于 方便查询 ，不建议更新视图的 数据。对视图数据的更改，都是通过对实际数据表里数据的操作来完成的。

## 修改、删除视图

### 修改视图

方法 1：

```sql
CREATE OR REPLACE VIEW empvu80 
(id_number, name, sal, department_id) 
AS 
SELECT employee_id, first_name || ' ' || last_name, salary, department_id FROM employees WHERE department_id = 80;
```

CREATE VIEW 子句中各列的别名应和子查询中各列相对应。

方法二：

```sql
ALTER VIEW 视图名称 
AS 查询语句
```

### 删除视图

删除视图只是删除视图的定义，并不会删除基表的数据。

```sql
DROP VIEW IF EXISTS 视图名称;
```

说明：基于视图 a、b 创建了新的视图 c，如果将视图 a 或者视图 b 删除，会导致视图 c 的查询失败。这 样的视图 c 需要手动删除或修改，否则影响使用。

## 总结

### 优点

1. 操作简单 将经常使用的查询操作定义为视图，可以使开发人员不需要关心视图对应的数据表的结构、表与表之间 的关联关系，也不需要关心数据表之间的业务逻辑和查询条件，而只需要简单地操作视图即可，极大简 化了开发人员对数据库的操作。

2. 减少数据冗余 视图跟实际数据表不一样，它存储的是查询语句。所以，在使用的时候，我们要通过定义视图的查询语 句来获取结果集。而视图本身不存储数据，不占用数据存储的资源，减少了数据冗余。

3. 数据安全 MySQL 将用户对数据的 访问限制 在某些数据的结果集上，而这些数据的结果集可以使用视图来实现。用 户不必直接查询或操作数据表。这也可以理解为视图具有 隔离性 。视图相当于在用户和实际的数据表之 间加了一层虚拟表。 同时，MySQL 可以根据权限将用户对数据的访问限制在某些视图上，用户不需要查询数据表，可以直接 通过视图获取数据表中的信息。这在一定程度上保障了数据表中数据的安全性。

4. 适应灵活多变的需求 当业务系统的需求发生变化后，如果需要改动数据表的结构，则工作量相对较 大，可以使用视图来减少改动的工作量。这种方式在实际工作中使用得比较多。

5. 能够分解复杂的查询逻辑 数据库中如果存在复杂的查询逻辑，则可以将问题进行分解，创建多个视图 获取数据，再将创建的多个视图结合起来，完成复杂的查询逻辑。 DROP VIEW IF EXISTS 视图名称 1, 视图名称 2, 视图名称 3,...; DROP VIEW empvu80;

### 缺点

如果我们在实际数据表的基础上创建了视图，那么，如果实际数据表的结构变更了，我们就需要及时对 相关的视图进行相应的维护。特别是嵌套的视图（就是在视图的基础上创建视图），维护会变得比较复 杂， 可读性不好 ，容易变成系统的潜在隐患。因为创建视图的 SQL 查询可能会对字段重命名，也可能包 含复杂的逻辑，这些都会增加维护的成本。

实际项目中，如果视图过多，会导致数据库维护成本的问题。

所以，在创建视图的时候，你要结合实际项目需求，综合考虑视图的优点和不足，这样才能正确使用视 图，使系统整体达到最优。
